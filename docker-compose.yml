services:
  db:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: keyway
      POSTGRES_PASSWORD: keyway
      POSTGRES_DB: keyway
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keyway"]
      interval: 5s
      timeout: 5s
      retries: 5

  crypto:
    build: ./keyway-crypto
    environment:
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - GRPC_PORT=${GRPC_PORT:-50051}
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost ${GRPC_PORT:-50051} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  backend:
    build: ./keyway-backend
    environment:
      - PORT=8080
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL:-postgresql://keyway:keyway@db:5432/keyway}
      - CRYPTO_SERVICE_URL=${CRYPTO_SERVICE_URL:-crypto:50051}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      - JWT_SECRET=${JWT_SECRET}
      # GitHub App (unified auth + repo access)
      - GITHUB_APP_ID=${GITHUB_APP_ID}
      - GITHUB_APP_CLIENT_ID=${GITHUB_APP_CLIENT_ID}
      - GITHUB_APP_CLIENT_SECRET=${GITHUB_APP_CLIENT_SECRET}
      - GITHUB_APP_PRIVATE_KEY=${GITHUB_APP_PRIVATE_KEY}
      - GITHUB_APP_WEBHOOK_SECRET=${GITHUB_APP_WEBHOOK_SECRET}
      - GITHUB_APP_NAME=${GITHUB_APP_NAME:-keyway-app}
      # GitHub Enterprise (optional)
      - GITHUB_BASE_URL=${GITHUB_BASE_URL:-}
      # Frontend URLs (derived from DOMAIN)
      - FRONTEND_URL=${FRONTEND_URL:-https://${DOMAIN:-keyway.sh}}
      - DASHBOARD_URL=${DASHBOARD_URL:-https://app.${DOMAIN:-keyway.sh}}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-https://${DOMAIN:-keyway.sh},https://app.${DOMAIN:-keyway.sh},https://api.${DOMAIN:-keyway.sh}}
      # Optional: Billing
      - BILLING_ENABLED=${BILLING_ENABLED:-false}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      # Optional: Email
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      # Optional: Analytics
      - POSTHOG_API_KEY=${POSTHOG_API_KEY:-}
      - POSTHOG_HOST=${POSTHOG_HOST:-}
    depends_on:
      db:
        condition: service_healthy
      crypto:
        condition: service_healthy

  dashboard:
    build:
      context: ./keyway-dashboard
      args:
        - NEXT_PUBLIC_KEYWAY_API_URL=https://api.${DOMAIN:-keyway.sh}
        - NEXT_PUBLIC_POSTHOG_KEY=${NEXT_PUBLIC_POSTHOG_KEY:-}
        - NEXT_PUBLIC_POSTHOG_HOST=${NEXT_PUBLIC_POSTHOG_HOST:-}
        - NEXT_PUBLIC_SENTRY_DSN=${NEXT_PUBLIC_SENTRY_DSN:-}
        - NEXT_PUBLIC_CRISP_WEBSITE_ID=${NEXT_PUBLIC_CRISP_WEBSITE_ID:-}
        - NEXT_PUBLIC_DISABLE_IMAGE_OPTIMIZATION=true
    depends_on:
      - backend

  landing:
    build:
      context: ./keyway-landing
      args:
        - NEXT_PUBLIC_DASHBOARD_URL=https://app.${DOMAIN:-keyway.sh}
        - NEXT_PUBLIC_POSTHOG_KEY=${NEXT_PUBLIC_POSTHOG_KEY:-}
        - NEXT_PUBLIC_POSTHOG_HOST=${NEXT_PUBLIC_POSTHOG_HOST:-}
        - NEXT_PUBLIC_SENTRY_DSN=${NEXT_PUBLIC_SENTRY_DSN:-}
        - NEXT_PUBLIC_CRISP_WEBSITE_ID=${NEXT_PUBLIC_CRISP_WEBSITE_ID:-}
        - NEXT_PUBLIC_DISABLE_IMAGE_OPTIMIZATION=true

  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN=${DOMAIN:-keyway.sh}
    volumes:
      - ${CADDYFILE:-./Caddyfile.production}:/etc/caddy/Caddyfile:ro
      - ${CADDY_CERTS:-./certs}:/etc/certs:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - landing
      - dashboard
      - backend

volumes:
  postgres_data:
  caddy_data:
  caddy_config:
